FROM ubuntu:focal 

ENV NODE_VERSION=14.15.4
RUN apt-get update && \
	apt-get install wget curl ca-certificates rsync -y
RUN wget -qO- https://raw.githubusercontent.com/creationix/nvm/v0.33.2/install.sh | bash
ENV NVM_DIR=/root/.nvm
RUN . "$NVM_DIR/nvm.sh" && nvm install ${NODE_VERSION}
RUN . "$NVM_DIR/nvm.sh" &&  nvm use v${NODE_VERSION}
RUN . "$NVM_DIR/nvm.sh" && nvm alias default v${NODE_VERSION}
RUN cp /root/.nvm/versions/node/v${NODE_VERSION}/bin/node /usr/bin/
RUN cp /root/.nvm/versions/node/v${NODE_VERSION}/bin/npm /usr/bin/
RUN /root/.nvm/versions/node/v${NODE_VERSION}/bin/npm install  leasot@latest -g
RUN apt-get install nginx -y
COPY docker/nginx/nginx.conf /etc/nginx/nginx.conf
RUN cd /home
RUN mkdir project
RUN npm i pm2 -g -y


WORKDIR /home/project
COPY package.json .babelrc ./
COPY apiserver ./apiserver/
COPY public ./public/
COPY src ./src/
COPY webpack ./webpack/

RUN cd /home/project
RUN npm i
RUN npm run build
RUN pm2 start --name apiserver apiserver/main.js


EXPOSE 80
ENTRYPOINT pm2 start --name ssr  dist/server.generated.js


